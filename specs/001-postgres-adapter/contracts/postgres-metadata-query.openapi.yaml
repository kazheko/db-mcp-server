openapi: 3.1.0
info:
  title: PostgreSQL Metadata Adapter Invocation
  version: 0.1.0
  description: >-
    Describes the adapter-level contract that the future MCP tool will call to
    execute validated, read-only PostgreSQL metadata queries using the shared
    `QueryAdapter` envelope.
servers:
  - url: mcp://stdio
    description: Internal MCP stdio transport hosted by db-mcp-server
paths:
  /adapters/postgres/metadata-query:
    post:
      summary: Execute a validated metadata query via the PostgreSQL adapter
      description: >-
        Issues a single SELECT/WITH/EXPLAIN statement targeting system catalogs
        through the adapter after the SQL validation decorator approves it.
        Configuration is sourced exclusively from `POSTGRES_CONNECTION_STRING`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostgresMetadataQueryRequest'
      responses:
        '200':
          description: Successful metadata payload returned to the caller
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostgresMetadataQueryResponse'
        '422':
          description: Validation decorator rejected the SQL statement
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '500':
          description: Underlying PostgreSQL driver error surfaced verbatim
components:
  schemas:
    QueryResponseEnvelope:
      type: object
      required: [correlationId, database, queryResult, startedAt, completedAt]
      properties:
        correlationId:
          type: string
          format: uuid
          description: Shared identifier echoed through logs and MCP responses.
        database:
          type: string
          description: Echo of the logical database name provided in the request.
        queryResult:
          type: array
          description: JSON rows limited to metadata/statistics data.
          items:
            type: object
            additionalProperties: {}
        startedAt:
          type: string
          format: date-time
          description: ISO timestamp captured immediately before adapter invocation.
        completedAt:
          type: string
          format: date-time
          description: ISO timestamp captured immediately after adapter completion.
        rowCount:
          type: integer
          description: Number of rows returned after enforcing the `maxRows` limit.
    PostgresMetadataQueryRequest:
      type: object
      required: [database, query]
      properties:
        database:
          type: string
          description: Logical label echoed back to MCP clients for context.
        query:
          type: string
          description: >-
            Single read-only SQL statement. Must target `pg_catalog`,
            `information_schema`, or statistics views and omit DDL/DML keywords.
        maxRows:
          type: integer
          minimum: 1
          maximum: 100
          default: 100
          description: Optional row cap applied before returning JSON data.
    PostgresMetadataQueryResponse:
      allOf:
        - $ref: '#/components/schemas/QueryResponseEnvelope'
        - type: object
          properties:
            queryResult:
              description: JSON rows sourced from `pg_catalog`/`information_schema` views only.
    ValidationErrorResponse:
      type: object
      required: [correlationId, message]
      properties:
        correlationId:
          type: string
          format: uuid
        message:
          type: string
          description: Strikethrough-formatted SQL plus "Validation Error" label.
